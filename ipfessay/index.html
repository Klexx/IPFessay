<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>IPFessay - Easily publish uncensorable essays</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
        <link rel="manifest" href="assets/icons/manifest.json">
        <link rel="mask-icon" href="assets/icons/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="shortcut icon" href="assets/icons/favicon.ico">
        <meta name="msapplication-config" content="assets/icons/browserconfig.xml">
        <meta name="theme-color" content="#5fcbcf">

        <link rel="stylesheet" href="assets/css/main.css">
        <link rel="stylesheet" href="assets/css/simplemde.min.css">

        <script src="assets/js/simplemde.min.js"></script>
        <script>
            (function() {

                var IPFessay = {

                    initialize : function() {

                        this.simplemde = new SimpleMDE({
                            autofocus: true,
                            element: document.querySelector('#text-input'),
                            toolbar: [
                            "bold", "italic", "heading", "|",
                            "quote", "unordered-list", "ordered-list", "|",
                            "link", "image", "table", "code", "|",
                            "preview", "side-by-side", "fullscreen", "|",
                            "guide"
                            ],
                        });

                        document.addEventListener('keyup', (event) => {

                            if(!this.overlayLoading && event.keyCode == 27)
                            this.closeOverlay();
                        });

                        document.querySelector('#overlay button').addEventListener('click', () => {

                            this.closeOverlay();
                        });

                        document.querySelector('.button-publish').addEventListener('click', () => {

                            this.openOverlay();

                            // Render the Markdown essay and post it to the IPFS daemon.
                            var f = new FormData();

                            this.simplemde.codemirror.save();

                            var md = document.querySelector('#text-input').value;
                            var renderedPage = this.renderPage(md);

                            f.append("path", new Blob([ renderedPage ], {type: "text/html"}), "path");

                            var req = new XMLHttpRequest();
                            req.addEventListener("load", this.publishCallback);
                            req.addEventListener("error", (error) => {

                                this.closeOverlay();

                                setTimeout(() => {

                                    alert('Error, try again.');

                                }, 30000);
                            });
                            req.open("post", window.location.protocol + "//" + window.location.hostname + ":5001/api/v0/add?stream-channels=true");
                            req.send(f);
                        });
                    },

                    openOverlay : function() {

                        document.body.className = 'noscroll';

                        document.querySelector('#overlay').style.display = 'block';
                        document.querySelector('#overlay .loading').style.display = 'block';
                        document.querySelector('#overlay section').style.display = 'none';

                        this.overlayLoading = true;
                    },

                    closeOverlay : function() {

                        document.body.className = '';

                        document.querySelector('#overlay').style.display = 'none';
                        document.querySelector('#overlay section').style.display = 'none';
                    },

                    showLink : function(url) {

                        this.overlayLoading = false;

                        document.querySelector('#overlay .loading').style.display = 'none';
                        document.querySelector('#overlay section').style.display = 'block';

                        document.querySelector('#overlay a').href = url;
                        document.querySelector('#overlay a').innerText = url;
                    },

                    publishCallback: function() {

                        var url = "/ipfs/" + JSON.parse(this.responseText).Hash;

                        IPFessay.showLink(url);
                    },

                    renderPage: function(md) {

                        return  '<html>' +
                            '<head>' +
                                '<meta name="viewport" content="width=device-width, initial-scale=1">' +
                                '<link rel="stylesheet" href="/ipfs/QmQ5j5PD8yroiMjCPLmVuAQC8JWAnBAfbZnThnV36Zs397">' +
                                '<style>' +
                                    'footer {padding: 3em 0; text-align: center; font-size: 1.4em; border-top: 1px solid #e1e1e1;}' +
                                    'a:hover { color: #222; border-bottom-color: #555}' +
                                    'a { color: #aeaeae; border-bottom: 1px dotted #aeaeae; text-decoration: none; }' +
                                    '</style>' +
                                '</head>' +
                            '<body>' +
                                '<article class="typesettings golden">' +
                                this.simplemde.markdown(md) +
                                '</article>' +
                                '<footer><a href="/ipns/QmSWnBwMKZ28tcgMFdihD8XS7p6QzdRSGf71cCybaETSsU">Publish your own essay with IPFessay</a>' +
                                ' | <a href="https://gitlab.com/stavros/IPFessay">Gitlab</a></footer>' +
                                '</body>' +
                            '</html>';
                    }
                };

                window.IPFessay = IPFessay;
            })();

            window.addEventListener('DOMContentLoaded', () => { IPFessay.initialize(); });
        </script>

    </head>
    <body>
        <header>
            <img src="assets/images/logo.svg" width="100"/>
            <h1>IPFessay</h1>
            <h2>Easily publish uncensorable essays</h2>
        </header>
        <article>
            <textarea id="text-input" style="width: 100%;" oninput="this.editor.update()" rows="15" cols="60">
# Your essay

Write your essay in this text box, using [Markdown syntax](https://daringfireball.net/projects/markdown/syntax), and use the toolbar at the top to compose or to preview how it will look.

When you've finished writing, press the "Publish" button at the bottom of this page, and your essay will be permanently uploaded to [IPFS](https://ipfs.io/), where it can never be changed or deleted.

**NOTE**: To use IPFessay, you *need to be running a local IPFS daemon in writable mode*, and you need to **[allow CORS](https://github.com/ipfs/js-ipfs-api#cors)**! If you don't, IPFessay unfortunately *can't publish files*.

# Markdown

> Many Markdown features are supported.

## Headers

* Lists.
* More lists.

Some plain text.

1. Numbered lists.
2. More numbers.

~~~
Code blocks
    are supported too.
~~~
            </textarea>

            <button class="button-publish pure-button">Publish</button>

        </article>

        <footer>
            <p>
            <a href="https://gitlab.com/stavros/IPFessay">Gitlab repository</a> |
            <a href="https://twitter.com/stavros">@stavros</a> |
            <a href="https://twitter.com/stelabouras">@stelabouras</a>
            </p>
        </footer>

        <div id="overlay">
            <span class="loading"><em>Loading...</em></span>

            <section>
                <h3>Here is your published link</h3>
                <a href="://ipfs.io" target="_blank">ipfs.io</a>
                <button class="pure-button">Close</button>
            </section>
        </div>

    </body>
</html>
